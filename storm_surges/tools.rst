.. _StormTools:

Tools
===================================================================================================

An sample script for analyzing storm surge results can be found here: `analysisSS.ipynb <http://nbviewer.ipython.org/urls/bitbucket.org/salishsea/analysis/raw/tip/storm_surges/analysisSS.ipynb>`_.

There are also a variety of functions described in `salishsea_tools/stormtools`_.

.. _salishsea_tools/stormtools: http://salishsea-meopar-tools.readthedocs.org/en/latest/SalishSeaTools/salishsea-tools.html#module-stormtools

Some of these functions are used to calculate the observed residual, modelled residual, error statistics, and so on.

.. note::

  A different module was used for analysis in the AO storm surge paper. 
It is in a private repository :file:`storm-surge/stormtools_revisions.py`.
The functions are almost identical as :file:`stormtools.py` but with a few minor changes.

The surge
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

We are often interested in the behaviour of the surge component of the water level, that is the anomaly after the tides have been removed.
Further, we could like to compare the modelled surge to the observed surge.
To determine the modelled surge, we perform two simulations: one with all of our forcing conditions, including the tides, atmopsheric conditions, rivers, and sea surface height at the open boundaries and another with only the tidal forcing and rivers.
We define the modelled surge as the difference between the sea surface height of these two simulations.

To calculate the observed surge, we need water level observations and tidal predictions.


Observations
^^^^^^^^^^^^^

Water level observations for Canadian tide gauges are easily obtained from the `Fisheries and Oceans Canada`_ (DFO) website.
We also use obserations from `NOAA`_ tide gauges.


.. _Fisheries and Oceans Canada: http://www.meds-sdmm.dfo-mpo.gc.ca/isdm-gdsi/twl-mne/maps-cartes/inventory-inventaire-eng.asp

.. _NOAA: http://tidesandcurrents.noaa.gov/stations.html?type=Water+Levels

Tidal predictions
^^^^^^^^^^^^^^^^^^

Tidal predictions are generated using a MATLAB package called `t_tide`_.
The general prodcedure is as follows:

1. A harmonic analysis is applied to a year-long time series using :file:`t_tide`.
2. The tidal constituents produced by the harmonic analysis are used to generate a tidal prediction.
Typically, 67 constituents are anlayzed with :file:`t_tide`

However, there are some subtleties that need to be considered before we generate the tidal predictions for use in residual calculations.

.. _t_tide: http://www.eos.ubc.ca/~rich/#T_Tide

Filtering
~~~~~~~~~~~~~~~~~

In a year with many storm surges, the harmonic analysis may result in over predicted constituents due to the large surges.
As such, before the harmonic analysis is perfomed, we filter the time series by applying a Doodson tide filter (Parker, 2007) and we remove periods with large non-tidal energy.
The harmonic analysis is then applied to the filtered time series.

Long Period Constituents
~~~~~~~~~~~~~~~~~~~~~~~~

In a harmonic analysis, long period constituents (Sa, Ssa, etc) in this region are often contaminated by non-tidal energy due to seasonal meteoroligcal events. We would like to represent this seasonal variability in our residual forcing. As such, we do not include long period constitents in our tidal predictions.

Constituents with low signal to noise ratio
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Constituents with a low signal to noise ratio (less than 2) are not used in tidal predictions.


Model Correction
~~~~~~~~~~~~~~~~~

Because our model is forced with only 8 tidal constituents, our water level predictions are missing some tidal energy.
We have attempted to correct for the missing energy in the following way.

1. Generate a tidal prediction with constituents from the harmonic analysis (excluding long period constitents, constituents with low signal to noise ratio, and shallow water constituents).
2. Generate a tidal prediction with only the eight constituents used to force the model.
3. Calculate the difference between these two predictions and add to the model sea surface height as a correction.

The shallow water constituents are excluded from the tidal prediction because they will be generated by the model and we should avoid counting them twice.


MATLAB Scripts
~~~~~~~~~~~~~~~

Serveral MATLAB scripts have been designed to calculate the tidal predictions as described above.
These scripts are found in the :file:`analysis/storm_surges/data/` repository and are described below.

* :file:`get_ttide_8_filter.m` - This script does most of the work. ::

  get_ttide_8_filter(csvfilename, location, starts, ends, type)

This function takes a csv file with water level observations from either the DFO website or the NOAA website to calculate tidal harmonics and tidal predictions over a time period defined by date strings :file:`starts` and :file:`ends`.
The type argument specifies if the observations are from NOAA or DFO.
It then saves harmonics in :file:`location_harmonics_date1_date2_filter.csv` where location is one of the arguments of :file:`get_ttide_8`.
:file:`date1` and :file:`date2` are string representations of the start and end date of the observation time series.
This function also saves a file called :file:`location_t_tide_compare8_starts_ends_snr2_filter.csv` where :file:`starts` and :file:`ends` are arguments of :file:`get_ttide_8_filter`.
This file saves three types of tidal predictions:

    + pred_all - predictions with all constituents except shallow water and ones with low signal to noise
    + pred_8 - predictions with onl eight constituents
    + pred_noshallow - like pred_all but with no shallow water constituents.
* :file:`calculate_haoomnics.m` and :file:`calculate_harmonics_NOAA.m` - these files perform the harmonics calculation for DFO and NOAA data respectively.
* :file:`filter_tides.m` and `file:filter_tides_NOAA.m` - these files do the filtering work.
* :file:`get_ttide_8.m` and :file:`calculate_harmonics.m` - these files only work for DFO data and do not apply the filtering or removal of shallow water/ long period constituents.

.. note::

  The NOAA observations csv files should have the station's latitude in the second row, second column of the file.

Other tidal predictions
~~~~~~~~~~~~~~~~~~~~~~~~

A few other files have been developed to generate tidal predictions based on Canadian Hydrographic Service constituents.
These methods do not remove the long period/shallow water constituents.
These files are in a private repository :file:`private-tools/tides`.

* :file:`tide_pred8.m` - generate tidal prediction with all CHS constituents and with only eight.
The function works in a similar manner to the other ones.  ::

   tide_pred8(tidefile,location,starts, ends)

Predictions are saved in a file :file:`location_atide_compare8_starts_ends.csv`.

Storm surge forcing files
^^^^^^^^^^^^^^^^^^^^^^^^^^

Several notebooks have been developed for generating the anomaly forcing files in simulation hindcasts.

* `SSH_Tofino.ipynb`_
* `SSH_PortHardy.ipynb`_

.. _SSH_Tofino.ipynb: http://nbviewer.ipython.org/urls/bitbucket.org/salishsea/tools/raw/tip/I_ForcingFiles/OBC/SSH_Tofino.ipynb

.. _SSH_PortHardy.ipynb: http://nbviewer.ipython.org/urls/bitbucket.org/salishsea/tools/raw/tip/I_ForcingFiles/OBC/SSH_PortHardy.ipynb

References
^^^^^^^^^^
Pawlowicz, R., B. Beardsley, and S. Lentz (2002). Classical tidal harmonic analysis including error estimates in matlab using t tide. Computers & Geosciences 28 (8), 929-937.

Parker, B. B. (2007). Tidal Analysis and Prediction. NOAA Special Publication  NOS CO-OPS 3.
